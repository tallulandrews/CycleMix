---
title: "CycleMix: Cell Cycle Assignment for scRNAseq data"
author: "Tallulah Andrews"
output: 
  BiocStyle::html_document
package: CycleMix
vignette: >
  %\VignetteIndexEntry{CycleMix: Cell Cycle Assignment for scRNAseq data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, echo=FALSE, results="hide", message=FALSE}
require(knitr)
opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
```

```{r setup}
set.seed(1973)
library("CycleMix")
library("SingleCellExperiment")
library("scater")
```
# Introduction

Droplet-based single-cell RNA sequencing (scRNAseq) enables the assaying of tens of thousands to millions of cells. One important feature of those cells is often which of those cells are actively proliferating and which are not. In addition, we may want to remove the transcriptional signature of this proliferation from our scRNAseq to avoid cells being clustered together simply because they are within the same cell-cycle stage.

This package implements a method for robustly classifying single cells by their cell-cycle phase and flexibly regressing out the transcriptional differences between any combination of phases specified by the user. This enables both complete regression of transcriptional differences related to the cell-cycle or simply regressing out differences between different phases of the cellcycle while preserving differences between proliferating and non-proliferating cells.

# Input Data 

CycleMix requires a matrix or object containing single-cell or single-nucleus RNAseq data. Single-cell spatial transcriptomics data can also be used. As well as a table of marker genes for each cell state to classify cells into - we have provided tables for the cell-cycle phases in this package.

CycleMix can use a SingleCellExperiment object, a Seurat object, or a matrix or sparse matrix as input. We have provided a SCE and Seurat object for this tutorial. Data must be normalized prior to using CycleMix, this can be accomplished using sctransform, vst, scran or any other normalization approach. Batch-effect corrected counts are also compatible with CycleMix.


## SingleCellExperiment
When using a SingleCellExperiment object, CycleMix will automatically look for a column called "feature_symbol" for the gene names that match those in the marker table.

```{r}
head(rowData(Ex))
```

You should also have a log-transformed normalized expression matrix in the SingleCellExperiment object, by default CycleMix uses the matrix named "logcounts", but any matrix can be specified.:

```{r}
names(assays(Ex))
```

See the SingleCellExperiment, scater, or scran packages for details on creating and normalizing data in SingleCellExperiment objects.

## Seurat Object
CycleMix is compatible with Seurat(v5). When using CycleMix with multiple samples of scRNAseq data in Seurat, you must use `JoinLayers()` to merge the samples into a single assay matrix prior to using CycleMix. 
```{r}
sample1 <- Seurat::CreateSeuratObject(counts=Ex2.2$counts, meta.data=Ex2.2$meta)
sample2 <- Seurat::CreateSeuratObject(counts=Ex2.2$counts, meta.data=Ex2.2$meta)
all_data <- merge(sample1, sample2, add.cell.ids=c("sample1", "sample2"))

all_data_joined <- SeuratObject::JoinLayers(all_data)
all_data_joined <- Seurat::NormalizeData(all_data_joined)
```

Alternatively, using SCTransform on the entire object will automatically join the layers together.
```{r}
all_data_sct <- Seurat::SCTransform(all_data)
```

## Normalized / Batch Corrected expression matrix
For maximum flexibility, CycleMix is also compatible with data provided as a matrix or Matrix from any type of normalization or batch effect correction. Here we will extract the Pearson residuals from sctransform as an example.

```{r}
corrected_mat <- Seurat::GetAssayData(all_data_sct, assay="SCT", layer="scale.data")
```

## Marker Matrix
The marker matrix must have 3 columns: 
- Gene : Gene names that match those in your matrix / object
- Stage : Which cell-cycle stage or other cell-state the marker is associated with.
- Dir : a quantitative score indicating the strength and/or directions of the association. Positive values are genes upregulated in the stage, negative values are genes down regulated in the stage.

```{r}
head(MGeneSets$Cyclone)
```
The "Dir" column is used to weight the gene expression we have simplified this to positive (1) and negative (-1) markers, but any numeric value can be used, for instance fold change.

We have provided tables with gene symbols for published cell-cycle marker gene sets. You can find the details for these gene sets using:

```{r eval=FALSE}
?HGeneSets
```
### Converting & Combining GeneSets
We can convert human cell-cycle genes to mouse orthologs using biomaRt with our provided wrappers. For instance if we want to use the quiescence markers in mouse we would convert them as so:

```{r eval=FALSE}
require("biomaRt") 
map <- CycleMix::downloadEnsemblData()
mouse_g0 <- HGeneSets$Quiesc
mouse_g0$Gene <- CycleMix::mapGeneNames(map, mouse_g0$Gene, in.name="symbol", in.org="Hsap", out.name="symbol", out.org="Mmus")
mouse_g0 <- mouse_g0[mouse_g0$Gene != "",]
```

Gene sets can also be combined together easily:

```{r, eval=FALSE}
mouse_CC <- rbind(mouse_g0, MGeneSets$Cyclone)
```

# Assigning Cells

We can now assign cell-cycle stages to our cells. For our example data we know all the cells are cycling thus won't include the quiescence markers.


## SingleCellExperiment Object
```{r}
output <- CycleMix::classifyCells(Ex, MGeneSets$Cyclone, symbol_column="feature_symbol") 
print(summary(factor(output$phase)))
```
Our example data comes from staged cells so we can compare our assignments to the ground truth:

```{r}
table(factor(output$phase), Ex$cell_type1)
```

We can also examine the gaussian mixture model fit to each cell-cycle stage:
```{r mixture-plot, dev='png', out.width="4in", out.height="4in"}
plotMixture(output$fit[["G2M"]], BIC=TRUE)
```
The plot on the left shows the 6 different models considered : mixtures of 1-3 gaussian distributions with equal (E) or different (V) variances. The BIC criterion was used to select the optimal model. The plot on the right shows the distribution of expression scores across all cells. The curves of the fitted distributions are plotted on top. The threshold for assigning cells to the stage (if applicable) is indicated with the red dotted line.

## Seurat Object
CycleMix is also compatible with Seurat(v5), and will automatically extract the appropriate data, but we must first identify the appropriat assay
```{r}
require(Seurat)
require(SingleCellExperiment)
# Using joined samples:
output1 <- CycleMix::classifyCells(all_data_joined, HGeneSets$Tirosh, expr_name="RNA")
# Using SCT normalized samples:
output2 <- CycleMix::classifyCells(all_data_sct, HGeneSets$Tirosh, expr_name="SCT")
```
CycleMix automatically uses the "data" layer of the selected assay, if you wish to use the Pearson residuals from SCT instead you would extract the matrix and run like so:

```{r}
corrected_mat <- Seurat::GetAssayData(all_data_sct, assay="SCT", layer="scale.data")
output3 <- CycleMix::classifyCells(corrected_mat, HGeneSets$Tirosh)
```

## matrix / Sparse Matrix
For compatibility with other object types, one can run directly on a sparse matrix, note that the matrix should be fully normalized, and batch-effect corrected (if applicable) prior to running CycleMix.
```{r}
sparse_mat <- logcounts(Ex)
rownames(sparse_mat) <- rowData(Ex)[,1]
output <- classifyCells(sparse_mat, MGeneSets$Cyclone, symbol_column=NULL)
```

# CellCycle Regression


## Session information

```{r}
sessionInfo()
```
